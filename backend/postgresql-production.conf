# ============================================================================
# PostgreSQL Production Configuration for MailerSuite2
# ============================================================================
# This file contains optimized PostgreSQL settings for production use
# Copy these settings to your postgresql.conf or use as reference
# ============================================================================

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================

# Maximum number of concurrent connections
max_connections = 200

# Maximum number of connections per database
max_connections_per_database = 100

# Maximum number of connections per user
max_connections_per_user = 50

# ============================================================================
# MEMORY SETTINGS
# ============================================================================

# Shared buffer size (25% of RAM for dedicated PostgreSQL server)
shared_buffers = 1GB

# Effective cache size (75% of RAM for dedicated PostgreSQL server)
effective_cache_size = 3GB

# Work memory for query operations
work_mem = 16MB

# Maintenance work memory
maintenance_work_mem = 256MB

# ============================================================================
# WRITE-AHEAD LOG (WAL) SETTINGS
# ============================================================================

# WAL buffer size
wal_buffers = 16MB

# Checkpoint segments
checkpoint_segments = 32

# Checkpoint completion target
checkpoint_completion_target = 0.9

# WAL writer delay
wal_writer_delay = 200ms

# ============================================================================
# QUERY PLANNER SETTINGS
# ============================================================================

# Random page cost
random_page_cost = 1.1

# Effective IO concurrency
effective_io_concurrency = 200

# ============================================================================
# LOGGING SETTINGS
# ============================================================================

# Log level
log_level = 'warning'

# Log connections
log_connections = on

# Log disconnections
log_disconnections = on

# Log duration
log_duration = off

# Log statement
log_statement = 'none'

# Log temp files
log_temp_files = 0

# Log lock waits
log_lock_waits = on

# Log deadlocks
log_deadlocks = on

# Log checkpoints
log_checkpoints = on

# Log autovacuum
log_autovacuum_min_duration = 0

# ============================================================================
# AUTOVACUUM SETTINGS
# ============================================================================

# Enable autovacuum
autovacuum = on

# Autovacuum max workers
autovacuum_max_workers = 3

# Autovacuum naptime
autovacuum_naptime = 1min

# Autovacuum vacuum threshold
autovacuum_vacuum_threshold = 50

# Autovacuum analyze threshold
autovacuum_analyze_threshold = 50

# Autovacuum vacuum scale factor
autovacuum_vacuum_scale_factor = 0.2

# Autovacuum analyze scale factor
autovacuum_analyze_scale_factor = 0.1

# ============================================================================
# BACKGROUND WRITER SETTINGS
# ============================================================================

# Background writer delay
bgwriter_delay = 200ms

# Background writer LRU maxpages
bgwriter_lru_maxpages = 100

# Background writer LRU multiplier
bgwriter_lru_multiplier = 2.0

# ============================================================================
# ASYNCHRONOUS BEHAVIOR
# ============================================================================

# Synchronous commit
synchronous_commit = on

# Commit delay
commit_delay = 0

# Commit siblings
commit_siblings = 5

# ============================================================================
# QUERY TUNING
# ============================================================================

# Default statistics target
default_statistics_target = 100

# Constraint exclusion
constraint_exclusion = partition

# Cursor tuple fraction
cursor_tuple_fraction = 0.1

# From collapse limit
from_collapse_limit = 8

# Join collapse limit
join_collapse_limit = 8

# ============================================================================
# ERROR REPORTING AND LOGGING
# ============================================================================

# Log destination
log_destination = 'stderr'

# Logging collector
logging_collector = on

# Log directory
log_directory = 'log'

# Log filename
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Log rotation age
log_rotation_age = 1d

# Log rotation size
log_rotation_size = 100MB

# Log truncate on rotation
log_truncate_on_rotation = on

# ============================================================================
# STATISTICS SETTINGS
# ============================================================================

# Track activities
track_activities = on

# Track counts
track_counts = on

# Track functions
track_functions = all

# Track io timing
track_io_timing = on

# ============================================================================
# SECURITY SETTINGS
# ============================================================================

# SSL
ssl = on

# SSL ciphers
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'

# SSL prefer server ciphers
ssl_prefer_server_ciphers = on

# Password encryption
password_encryption = 'scram-sha-256'

# ============================================================================
# REPLICATION SETTINGS (if using replication)
# ============================================================================

# Maximum WAL senders
max_wal_senders = 3

# Maximum replication slots
max_replication_slots = 3

# Hot standby
hot_standby = on

# ============================================================================
# PERFORMANCE MONITORING
# ============================================================================

# Enable pg_stat_statements extension
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements settings
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on

# ============================================================================
# MAINTENANCE SETTINGS
# ============================================================================

# Autoanalyze
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.1

# Vacuum cost limit
vacuum_cost_limit = 200

# Vacuum cost page hit
vacuum_cost_page_hit = 1

# Vacuum cost page miss
vacuum_cost_page_miss = 10

# Vacuum cost page dirty
vacuum_cost_page_dirty = 20

# ============================================================================
# CONNECTION POOLING (if using PgBouncer)
# ============================================================================

# Connection pooling settings
# These are optimized for use with PgBouncer
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# ============================================================================
# APPLICATION-SPECIFIC OPTIMIZATIONS
# ============================================================================

# Optimize for email marketing workload
# Increase work_mem for complex queries
work_mem = 32MB

# Optimize for bulk operations
maintenance_work_mem = 512MB

# Increase checkpoint segments for bulk operations
checkpoint_segments = 64

# Optimize for concurrent users
max_connections = 300

# ============================================================================
# MONITORING AND DEBUGGING
# ============================================================================

# Enable query logging for slow queries
log_min_duration_statement = 1000

# Log all statements (temporary, for debugging)
# log_statement = 'all'

# Log parse, bind, and execute steps
# log_parser_stats = on
# log_planner_stats = on
# log_executor_stats = on

# ============================================================================
# BACKUP AND RECOVERY
# ============================================================================

# Archive mode (enable for continuous archiving)
# archive_mode = on
# archive_command = 'cp %p /path/to/archive/%f'

# Point-in-time recovery
# wal_level = replica

# ============================================================================
# NOTES AND RECOMMENDATIONS
# ============================================================================

# 1. Adjust shared_buffers and effective_cache_size based on your server RAM
# 2. Monitor pg_stat_statements for query performance
# 3. Use PgBouncer for connection pooling in high-concurrency scenarios
# 4. Regularly analyze and vacuum tables
# 5. Monitor WAL generation and checkpoint frequency
# 6. Adjust work_mem based on your query patterns
# 7. Consider partitioning large tables for better performance
# 8. Use appropriate indexes for your query patterns
# 9. Monitor connection usage and adjust max_connections accordingly
# 10. Regular maintenance and monitoring is crucial for production performance 